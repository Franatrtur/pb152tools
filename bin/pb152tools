#!/bin/bash

# Hardcode the install location. 
# Since we control the installer, we know exactly where this will be.
INSTALL_ROOT="$HOME/.pb152tools"

# --- Display Logo ---
YELLOW='\033[0;33m'
RESET='\033[0m'
LOGO_FILE="$INSTALL_ROOT/assets/logo.txt"

if [ -f "$LOGO_FILE" ]; then
    echo -e "${YELLOW}"
    cat "$LOGO_FILE"
    echo -e "${RESET}"
fi

# --- Display Version ---
VERSION_FILE="$INSTALL_ROOT/version.txt"
if [ -f "$VERSION_FILE" ]; then
    cat "$VERSION_FILE"
fi

# --- Check for updates ---
# This requires an internet connection and curl
REPO_CONFIG_FILE="$INSTALL_ROOT/repo.conf"
if [ -f "$REPO_CONFIG_FILE" ] && command -v curl &> /dev/null; then
    source "$REPO_CONFIG_FILE"
    
    # Assuming the default branch is 'main'.
    RAW_URL_BASE=$(echo "$REPO_URL" | sed 's/\.git$//' | sed 's/github.com/raw.githubusercontent.com/')/main
    REMOTE_VERSION_URL="$RAW_URL_BASE/version.txt"

    # Fetch remote version, with a timeout of 5 seconds
    REMOTE_VERSION_RAW=$(curl -sL --max-time 5 "$REMOTE_VERSION_URL")
    LOCAL_VERSION_RAW=$(cat "$VERSION_FILE")

    # Trim whitespace (like newlines) from versions for a reliable comparison
    REMOTE_VERSION=$(echo "$REMOTE_VERSION_RAW" | xargs)
    LOCAL_VERSION=$(echo "$LOCAL_VERSION_RAW" | xargs)

    # If remote fetch was successful and versions differ, show message
    if [ -n "$REMOTE_VERSION" ] && [ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]; then
        echo -e "Update available! ${LOCAL_VERSION} -> ${REMOTE_VERSION}. Run ${YELLOW}pb152tools update${RESET} to update."
    fi
fi

# Point to the isolated python
VENV_PYTHON="$INSTALL_ROOT/venv/bin/python"
SRC_DIR="$INSTALL_ROOT/src"

COMMAND="$1"
shift

if [ ! -f "$VENV_PYTHON" ]; then
    echo "Error: Corrupt installation. Python venv not found at $VENV_PYTHON"
    echo "Please re-run the installer."
    exit 1
fi

case "$COMMAND" in
    "advise")
        # Check if the advisor was installed
        if [ ! -f "$INSTALL_ROOT/.advisor_enabled" ]; then
            echo "Error: The AI Advisor is not installed."
            echo "To use this feature, please re-run the installer and choose 'y' when asked to install the advisor."
            exit 1
        fi
        "$VENV_PYTHON" "$SRC_DIR/advisor.py" "$@"
        ;;
    "exam")
        "$VENV_PYTHON" "$SRC_DIR/mock.py" "$@"
        ;;
    "format")
        "$VENV_PYTHON" "$SRC_DIR/format_practice.py" "$@"
        ;;
    "help"|"--help"|"-h")
        echo "Usage: pb152tools <command> [options]"
        echo ""
        echo "A collection of tools for the PB152 course."
        echo ""
        echo "Commands:"
        echo "  exam                Generate a mock exam."
        echo "  exam progress       Show your progress in the mock exams."
        echo "  exam reveal         Reveal the original filenames of the exam."
        echo "  exam hide           Hide the original filenames of the exam."
        echo "  exam trash          Remove the current exam without archiving."
        echo "  exam done           Archive the current exam."
        echo "  advise <file.c>     Get AI-powered advice on your C code."
        echo "  format              Practice C code formatting."
        echo "  update              Update pb152tools to the latest version."
        echo "  uninstall           Uninstall pb152tools."
        echo "  help                Show this help message."
        ;;
    "update"|"reinstall")
        echo "Preparing for reinstallation..."
        REINSTALL_SCRIPT_SOURCE="$INSTALL_ROOT/bin/reinstall.sh"
        
        if [ ! -f "$REINSTALL_SCRIPT_SOURCE" ]; then
            echo "Error: Reinstall script not found at $REINSTALL_SCRIPT_SOURCE"
            echo "Your installation may be corrupt. Please try installing manually."
            exit 1
        fi

        # Create a temporary file to copy the reinstall script to
        # This is the key to avoiding self-destruction
        TMP_REINSTALL_SCRIPT=$(mktemp /tmp/pb152tools-reinstaller.XXXXXX.sh)
        chmod +x "$TMP_REINSTALL_SCRIPT"
        
        # Copy the contents of the real reinstall script to the temporary one
        cat "$REINSTALL_SCRIPT_SOURCE" > "$TMP_REINSTALL_SCRIPT"

        echo "Handing over to the reinstallation process..."
        
        # Execute the temporary script, replacing the current process
        exec "$TMP_REINSTALL_SCRIPT"
        ;;
    "uninstall")
        read -p "Are you sure you want to uninstall pb152tools? This will remove ~/.pb152tools and symlinks. (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "Uninstalling pb152tools in the background..."
            # Copy uninstaller to /tmp to avoid "directory in use" errors
            TMP_UNINSTALLER="/tmp/pb152tools_uninstall.sh"
            cp "$INSTALL_ROOT/uninstall.sh" "$TMP_UNINSTALLER"
            chmod +x "$TMP_UNINSTALLER"

            # Run from /tmp in the background and detach
            nohup bash "$TMP_UNINSTALLER" > /dev/null 2>&1 &
            
            echo "Uninstallation process started. You can continue using your terminal."
            # Exit immediately to release file handles
            exit 0
        else
            echo "Uninstallation cancelled."
        fi
        ;;
    *)
        echo "Unknown command: $COMMAND"
        exit 1
        ;;
esac